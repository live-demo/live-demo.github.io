{"version":3,"file":null,"sources":["../index.js"],"sourcesContent":["\"use strict\";\n\nconst ACTION_REQUEST = \"REQUEST\";\nconst ACTION_RESPONSE = \"RESPONSE\";\nconst ACTION_PUSH = \"PUSH\";\nconst SESSION_ID_KEY = \"__shared-session-storage__session-id-key__\";\nconst PREFIX_KEY = \"##shared-session-storage##\";\nconst ACTIVE_SHARED_SESSION_IDS = \"__local-storage__active-shared-session-ids__\";\nconst SYNC_KEY = \"__local-storage__shared-shared-session-sync-key__\";\n\nconst global = window;\n\nclass SharedSessionStorage {\n    constructor() {\n        global.addEventListener(\"storage\", this, true);\n        global.addEventListener(\"unload\", this, true);\n\n        let sessionId = global.sessionStorage.getItem(SESSION_ID_KEY);\n        if (sessionId === null) {\n            sessionId = `SID#${Math.floor(Math.random() * 1e6)}$`;\n            global.sessionStorage.setItem(SESSION_ID_KEY, sessionId);\n        }\n        this.sessionId = sessionId;\n        let keys = global.localStorage.getItem(ACTIVE_SHARED_SESSION_IDS);\n        if (keys) {\n            if (keys.indexOf(sessionId) > -1) {\n                keys = keys.replace(sessionId, \"\");\n            }\n            if (keys) {\n                let idx = keys.indexOf(\"$\");\n                if (idx === -1) {\n                    idx = keys.length;\n                } else {\n                    idx += 1;\n                }\n                const targetId = keys.slice(0, idx);\n                this.__sync__({\n                    action: ACTION_REQUEST,\n                    originalId: this.sessionId,\n                    targetId: targetId,\n                });\n            }\n            keys += this.sessionId;\n        } else {\n            keys = this.sessionId;\n        }\n        global.localStorage.setItem(ACTIVE_SHARED_SESSION_IDS, keys);\n    }\n    __sync__(data) {\n        global.localStorage.setItem(SYNC_KEY, JSON.stringify(data));\n        global.localStorage.removeItem(SYNC_KEY);\n    }\n    handleEvent(evt) {\n        switch (evt.type) {\n            case \"storage\":\n                return this.__handleStorage__(evt);\n            case \"unload\":\n                global.removeEventListener(\"storage\", this, true);\n                global.removeEventListener(\"unload\", this, true);\n                return this.__handleUnload__(evt);\n        }\n    }\n    __handleStorage__(evt) {\n        const key = evt.key;\n        const newValue = evt.newValue;\n        if (key !== SYNC_KEY || newValue == null) {\n            return;\n        }\n        const obj = JSON.parse(newValue);\n        switch (obj.action) {\n            case ACTION_REQUEST:\n                if (obj.targetId === this.sessionId) {\n                    const data = this.entries();\n                    this.__sync__({\n                        action: ACTION_RESPONSE,\n                        targetId: obj.originalId,\n                        originalId: obj.targetId,\n                        data: data,\n                    });\n                }\n                break;\n            case ACTION_RESPONSE:\n                if (obj.targetId === this.sessionId) {\n                    this.setAllItem(obj.data);\n                }\n                break;\n            case ACTION_PUSH:\n                if (obj.originalId !== this.sessionId) {\n                    this.setAllItem(obj.data);\n                }\n                break;\n        }\n    }\n    __handleUnload__(evt) {\n        let keys = global.localStorage.getItem(ACTIVE_SHARED_SESSION_IDS);\n        if (keys == null) {\n            return;\n        }\n        keys = keys.replace(this.sessionId, \"\");\n        if (keys.length === 0) {\n            global.localStorage.removeItem(ACTIVE_SHARED_SESSION_IDS);\n        } else {\n            global.localStorage.setItem(ACTIVE_SHARED_SESSION_IDS, keys);\n        }\n    }\n    __wrapKey__(key) {\n        return PREFIX_KEY + key;\n    }\n    __unwrapKey__(key) {\n        if (this.__hasWrappedKey__(key)) {\n            return key.slice(PREFIX_KEY.length);\n        } else {\n            return key;\n        }\n    }\n    __hasWrappedKey__(key) {\n        return key.indexOf(PREFIX_KEY) > -1;\n    }\n    keys() {\n        const keys = [];\n        const length = global.sessionStorage.length;\n        for (let i = 0; i < length; i++) {\n            const key = global.sessionStorage.key(i);\n            if (this.__hasWrappedKey__(key)) {\n                keys.push(this.__unwrapKey__(key));\n            }\n        }\n        return keys;\n    }\n    entries() {\n        const keys = this.keys();\n        const items = [];\n        for (let i = 0, len = keys.length; i < len; i++) {\n            const key = keys[i];\n            items.push([key, this.getItem(key)]);\n        }\n        return items;\n    }\n    setAllItem(iter) {\n        for (let i = 0, len = iter.length; i < len; i++) {\n            const ary = iter[i];\n            const key = this.__wrapKey__(ary[0]);\n            const val = ary[1];\n            if (val == null) {\n                global.sessionStorage.removeItem(key);\n            } else {\n                global.sessionStorage.setItem(key, val);\n            }\n        }\n    }\n    getItem(key) {\n        return global.sessionStorage.getItem(this.__wrapKey__(key));\n    }\n    setItem(key, val) {\n        const ret = global.sessionStorage.setItem(this.__wrapKey__(key), val);\n        this.__sync__({\n            action: ACTION_PUSH,\n            originalId: this.sessionId,\n            data: [[key, String(val)]],\n        });\n        return ret;\n    }\n    removeItem(key) {\n        const ret = global.sessionStorage.removeItem(this.__wrapKey__(key));\n        this.__sync__({\n            action: ACTION_PUSH,\n            originalId: this.sessionId,\n            data: [[key, null]],\n        });\n        return ret;\n    }\n    key(idx) {\n        const keys = [];\n        const length = global.sessionStorage.length;\n        for (let i = 0; i < length; i++) {\n            const key = global.sessionStorage.key(i);\n            if (this.__hasWrappedKey__(key)) {\n                keys.push(this.__unwrapKey__(key));\n                if (keys.length - 1 === idx) {\n                    return keys[keys.length - 1];\n                }\n            }\n        }\n    }\n    clear() {\n        const keys = this.keys();\n        const items = [];\n        for (let i = 0, len = keys.length; i < len; i++) {\n            const key = keys[i];\n            global.sessionStorage.removeItem(this.__wrapKey__(key));\n            items.push([key, null]);\n        }\n        this.__sync__({\n            action: ACTION_PUSH,\n            originalId: this.sessionId,\n            data: items,\n        });\n    }\n    get length() {\n        return this.keys().length;\n    }\n}\n\nexport default new SharedSessionStorage();\n"],"names":["ACTION_REQUEST","ACTION_RESPONSE","ACTION_PUSH","SESSION_ID_KEY","PREFIX_KEY","ACTIVE_SHARED_SESSION_IDS","SYNC_KEY","global","window","SharedSessionStorage","addEventListener","sessionId","sessionStorage","getItem","Math","floor","random","setItem","keys","localStorage","indexOf","replace","idx","length","targetId","slice","__sync__","data","JSON","stringify","removeItem","evt","type","__handleStorage__","removeEventListener","__handleUnload__","key","newValue","obj","parse","action","entries","originalId","setAllItem","__hasWrappedKey__","i","push","__unwrapKey__","items","len","iter","ary","__wrapKey__","val","ret","String"],"mappings":"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"}