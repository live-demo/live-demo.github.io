{"version":3,"file":null,"sources":["../index.js"],"sourcesContent":["\"use strict\";\n\nconst ACTION_REQUEST = \"REQUEST\";\nconst ACTION_RESPONSE = \"RESPONSE\";\nconst ACTION_PUSH = \"PUSH\";\nconst SESSION_ID_KEY = \"__shared-session-storage__session-id-key__\";\nconst PREFIX_KEY = \"##shared-session-storage##\";\nconst ACTIVE_SHARED_SESSION_IDS = \"__local-storage__active-shared-session-ids__\";\nconst SYNC_KEY = \"__local-storage__shared-shared-session-sync-key__\";\n\nconst global = window;\n\n// Ref: https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Polyfill\nfunction CustomEvent (event, params) {\n    params = params || {\n        bubbles: false,\n        cancelable: false,\n        detail: undefined,\n    };\n    const evt = document.createEvent(\"CustomEvent\");\n    evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);\n    return evt;\n}\nCustomEvent.prototype = global.Event.prototype;\n\nfunction createStorageEvent(data) {\n    const eventName = \"shared-session-storage\";\n    const params = {\n        bubbles: false,\n        cancelable: false,\n        detail: data,\n    };\n    if (global.CustomEvent) {\n        return new global.CustomEvent(eventName, params);\n    } else {\n        return new CustomEvent(eventName, params);\n    }\n}\n\nclass SharedSessionStorage {\n    constructor() {\n        global.addEventListener(\"storage\", this, true);\n        global.addEventListener(\"unload\", this, true);\n\n        let sessionId = global.sessionStorage.getItem(SESSION_ID_KEY);\n        if (sessionId === null) {\n            sessionId = `SID#${Math.floor(Math.random() * 1e6)}$`;\n            global.sessionStorage.setItem(SESSION_ID_KEY, sessionId);\n        }\n        this.sessionId = sessionId;\n        let keys = global.localStorage.getItem(ACTIVE_SHARED_SESSION_IDS);\n        if (keys) {\n            if (keys.indexOf(sessionId) > -1) {\n                keys = keys.replace(sessionId, \"\");\n            }\n            if (keys) {\n                let idx = keys.indexOf(\"$\");\n                if (idx === -1) {\n                    idx = keys.length;\n                } else {\n                    idx += 1;\n                }\n                const targetId = keys.slice(0, idx);\n                this.__sync__({\n                    action: ACTION_REQUEST,\n                    originalId: this.sessionId,\n                    targetId: targetId,\n                });\n            }\n            keys += this.sessionId;\n        } else {\n            keys = this.sessionId;\n        }\n        global.localStorage.setItem(ACTIVE_SHARED_SESSION_IDS, keys);\n    }\n    __sync__(data) {\n        global.localStorage.setItem(SYNC_KEY, JSON.stringify(data));\n        global.localStorage.removeItem(SYNC_KEY);\n    }\n    handleEvent(evt) {\n        switch (evt.type) {\n            case \"storage\":\n                return this.__handleStorage__(evt);\n            case \"unload\":\n                global.removeEventListener(\"storage\", this, true);\n                global.removeEventListener(\"unload\", this, true);\n                return this.__handleUnload__(evt);\n        }\n    }\n    __handleStorage__(evt) {\n        const key = evt.key;\n        const newValue = evt.newValue;\n        if (key !== SYNC_KEY || newValue == null) {\n            return;\n        }\n        const obj = JSON.parse(newValue);\n        switch (obj.action) {\n            case ACTION_REQUEST:\n                if (obj.targetId === this.sessionId) {\n                    const data = this.entries();\n                    this.__sync__({\n                        action: ACTION_RESPONSE,\n                        targetId: obj.originalId,\n                        originalId: obj.targetId,\n                        data: data,\n                    });\n                }\n                break;\n            case ACTION_RESPONSE:\n                if (obj.targetId === this.sessionId) {\n                    this.setAllItem(obj.data);\n                    const evt = createStorageEvent(obj.data);\n                    global.dispatchEvent(evt);\n                }\n                break;\n            case ACTION_PUSH:\n                if (obj.originalId !== this.sessionId) {\n                    this.setAllItem(obj.data);\n                    const evt = createStorageEvent(obj.data);\n                    global.dispatchEvent(evt);\n                }\n                break;\n        }\n    }\n    __handleUnload__(evt) {\n        let keys = global.localStorage.getItem(ACTIVE_SHARED_SESSION_IDS);\n        if (keys == null) {\n            return;\n        }\n        keys = keys.replace(this.sessionId, \"\");\n        if (keys.length === 0) {\n            global.localStorage.removeItem(ACTIVE_SHARED_SESSION_IDS);\n        } else {\n            global.localStorage.setItem(ACTIVE_SHARED_SESSION_IDS, keys);\n        }\n    }\n    __wrapKey__(key) {\n        return PREFIX_KEY + key;\n    }\n    __unwrapKey__(key) {\n        if (this.__hasWrappedKey__(key)) {\n            return key.slice(PREFIX_KEY.length);\n        } else {\n            return key;\n        }\n    }\n    __hasWrappedKey__(key) {\n        return key.indexOf(PREFIX_KEY) > -1;\n    }\n    keys() {\n        const keys = [];\n        const length = global.sessionStorage.length;\n        for (let i = 0; i < length; i++) {\n            const key = global.sessionStorage.key(i);\n            if (this.__hasWrappedKey__(key)) {\n                keys.push(this.__unwrapKey__(key));\n            }\n        }\n        return keys;\n    }\n    entries() {\n        const keys = this.keys();\n        const items = [];\n        for (let i = 0, len = keys.length; i < len; i++) {\n            const key = keys[i];\n            items.push([key, this.getItem(key)]);\n        }\n        return items;\n    }\n    setAllItem(iter) {\n        for (let i = 0, len = iter.length; i < len; i++) {\n            const ary = iter[i];\n            const key = this.__wrapKey__(ary[0]);\n            const val = ary[1];\n            if (val == null) {\n                global.sessionStorage.removeItem(key);\n            } else {\n                global.sessionStorage.setItem(key, val);\n            }\n        }\n    }\n    getItem(key) {\n        return global.sessionStorage.getItem(this.__wrapKey__(key));\n    }\n    setItem(key, val) {\n        const ret = global.sessionStorage.setItem(this.__wrapKey__(key), val);\n        this.__sync__({\n            action: ACTION_PUSH,\n            originalId: this.sessionId,\n            data: [[key, String(val)]],\n        });\n        return ret;\n    }\n    removeItem(key) {\n        const ret = global.sessionStorage.removeItem(this.__wrapKey__(key));\n        this.__sync__({\n            action: ACTION_PUSH,\n            originalId: this.sessionId,\n            data: [[key, null]],\n        });\n        return ret;\n    }\n    key(idx) {\n        const keys = [];\n        const length = global.sessionStorage.length;\n        for (let i = 0; i < length; i++) {\n            const key = global.sessionStorage.key(i);\n            if (this.__hasWrappedKey__(key)) {\n                keys.push(this.__unwrapKey__(key));\n                if (keys.length - 1 === idx) {\n                    return keys[keys.length - 1];\n                }\n            }\n        }\n    }\n    clear() {\n        const keys = this.keys();\n        const items = [];\n        for (let i = 0, len = keys.length; i < len; i++) {\n            const key = keys[i];\n            global.sessionStorage.removeItem(this.__wrapKey__(key));\n            items.push([key, null]);\n        }\n        this.__sync__({\n            action: ACTION_PUSH,\n            originalId: this.sessionId,\n            data: items,\n        });\n    }\n    get length() {\n        return this.keys().length;\n    }\n}\n\nexport default new SharedSessionStorage();\n"],"names":["ACTION_REQUEST","ACTION_RESPONSE","ACTION_PUSH","SESSION_ID_KEY","PREFIX_KEY","ACTIVE_SHARED_SESSION_IDS","SYNC_KEY","global","window","CustomEvent","event","params","undefined","evt","document","createEvent","initCustomEvent","bubbles","cancelable","detail","prototype","Event","createStorageEvent","data","eventName","SharedSessionStorage","addEventListener","sessionId","sessionStorage","getItem","Math","floor","random","setItem","keys","localStorage","indexOf","replace","idx","length","targetId","slice","__sync__","JSON","stringify","removeItem","type","__handleStorage__","removeEventListener","__handleUnload__","key","newValue","obj","parse","action","entries","originalId","setAllItem","dispatchEvent","__hasWrappedKey__","i","push","__unwrapKey__","items","len","iter","ary","__wrapKey__","val","ret","String"],"mappings":"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"}